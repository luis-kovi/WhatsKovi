generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPERVISOR
  AGENT
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
}

enum TicketStatus {
  PENDING
  OPEN
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  NOTE
}

enum MessageStatus {
  PENDING
  SENT
  RECEIVED
  READ
}

enum NotificationType {
  NEW_TICKET
  TICKET_MESSAGE
  TICKET_TRANSFER
}

enum NotificationChannel {
  IN_APP
  PUSH
  EMAIL
}

model User {
  id                String       @id @default(uuid())
  name              String
  email             String       @unique
  password          String
  role              UserRole     @default(AGENT)
  status            UserStatus   @default(OFFLINE)
  avatar            String?
  maxTickets        Int          @default(3)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  tickets           Ticket[]
  messages          Message[]
  queues            QueueUser[]
  messageReactions  MessageReaction[]
  quickReplies      QuickReply[]        @relation("UserQuickReplies")
  quickReplyUsages  QuickReplyUsage[]   @relation("UserQuickReplyUsage")
  contactNotes      ContactNote[]       @relation("UserContactNotes")
  contactSegments   ContactSegment[]    @relation("UserContactSegments")
  notifications     Notification[]
  notificationPreference NotificationPreference?
  notificationSubscriptions NotificationSubscription[]
  
  @@map("users")
}

model WhatsAppConnection {
  id                String       @id @default(uuid())
  name              String
  phoneNumber       String?
  status            String       @default("DISCONNECTED")
  qrCode            String?
  isDefault         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  tickets           Ticket[]
  
  @@map("whatsapp_connections")
}

model Contact {
  id                String       @id @default(uuid())
  name              String
  phoneNumber       String       @unique
  email             String?
  avatar            String?
  isBlocked         Boolean      @default(false)
  notes             String?
  customFields      Json?
  lastInteractionAt DateTime?    @default(now())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  tickets           Ticket[]
  tags              ContactTag[]
  customFieldValues ContactFieldValue[]
  notesHistory      ContactNote[]
  
  @@map("contacts")
}

model Queue {
  id                String       @id @default(uuid())
  name              String
  color             String       @default("#FF355A")
  description       String?
  greetingMessage   String?
  outOfHoursMessage String?
  priority          Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  tickets           Ticket[]
  users             QueueUser[]
  quickReplies      QuickReply[]        @relation("QueueQuickReplies")
  quickReplyUsages  QuickReplyUsage[]   @relation("QueueQuickReplyUsage")
  
  @@map("queues")
}

model QueueUser {
  id                String       @id @default(uuid())
  userId            String
  queueId           String
  
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  queue             Queue        @relation(fields: [queueId], references: [id], onDelete: Cascade)
  
  @@unique([userId, queueId])
  @@map("queue_users")
}

model Ticket {
  id                String       @id @default(uuid())
  status            TicketStatus @default(PENDING)
  priority          Priority     @default(MEDIUM)
  carPlate          String?
  unreadMessages    Int          @default(0)
  lastMessageAt     DateTime     @default(now())
  closedAt          DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  contactId         String
  contact           Contact      @relation(fields: [contactId], references: [id])
  
  userId            String?
  user              User?        @relation(fields: [userId], references: [id])
  
  queueId           String?
  queue             Queue?       @relation(fields: [queueId], references: [id])
  
  whatsappId        String
  whatsapp          WhatsAppConnection @relation(fields: [whatsappId], references: [id])
  
  messages          Message[]
  tags              TicketTag[]
  quickReplyUsages  QuickReplyUsage[]   @relation("TicketQuickReplyUsage")
  
  @@map("tickets")
}

model Message {
  id                String       @id @default(uuid())
  body              String
  type              MessageType  @default(TEXT)
  status            MessageStatus @default(PENDING)
  mediaUrl          String?
  isPrivate         Boolean      @default(false)
  quotedMsgId       String?
  createdAt         DateTime     @default(now())
  editedAt          DateTime?
  editedBy          String?
  
  ticketId          String
  ticket            Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId            String?
  user              User?        @relation(fields: [userId], references: [id])
  
  quotedMessage     Message?     @relation("MessageQuote", fields: [quotedMsgId], references: [id])
  replies           Message[]    @relation("MessageQuote")
  reactions         MessageReaction[]
  
  @@map("messages")
}

model MessageReaction {
  id        String   @id @default(uuid())
  emoji     String
  messageId String
  userId    String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
}

model Tag {
  id                String       @id @default(uuid())
  name              String       @unique
  color             String       @default("#FF355A")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  tickets           TicketTag[]
  contacts          ContactTag[]
  keywords          TagKeyword[]
  
  @@map("tags")
}

model TicketTag {
  id                String       @id @default(uuid())
  ticketId          String
  tagId             String
  
  ticket            Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag               Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([ticketId, tagId])
  @@map("ticket_tags")
}

model ContactTag {
  id                String       @id @default(uuid())
  contactId         String
  tagId             String
  
  contact           Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag               Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([contactId, tagId])
  @@map("contact_tags")
}

enum ContactFieldType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  SELECT
  MULTI_SELECT
}

model ContactField {
  id          String            @id @default(uuid())
  name        String
  key         String            @unique
  type        ContactFieldType  @default(TEXT)
  description String?
  options     String[]      @default([])
  isRequired  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  values      ContactFieldValue[]

  @@map("contact_fields")
}

model ContactFieldValue {
  id        String       @id @default(uuid())
  contactId String
  fieldId   String
  value     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  contact   Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field     ContactField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([contactId, fieldId])
  @@map("contact_field_values")
}

model ContactNote {
  id        String   @id @default(uuid())
  contactId String
  userId    String?
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user      User?    @relation("UserContactNotes", fields: [userId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@map("contact_notes")
}

model ContactSegment {
  id           String   @id @default(uuid())
  name         String
  description  String?
  filters      Json
  isFavorite   Boolean  @default(false)
  createdById  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdBy    User?    @relation("UserContactSegments", fields: [createdById], references: [id], onDelete: SetNull)

  @@map("contact_segments")
}

model QuickReply {
  id                String       @id @default(uuid())
  shortcut          String       @unique
  message           String
  mediaUrl          String?
  isGlobal          Boolean      @default(true)
  usageCount        Int          @default(0)
  lastUsedAt        DateTime?
  ownerId           String?
  queueId           String?
  categoryId        String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  owner             User?                @relation("UserQuickReplies", fields: [ownerId], references: [id], onDelete: SetNull)
  queue             Queue?               @relation("QueueQuickReplies", fields: [queueId], references: [id], onDelete: SetNull)
  category          QuickReplyCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  usages            QuickReplyUsage[]

  @@map("quick_replies")
}

model QuickReplyCategory {
  id          String      @id @default(uuid())
  name        String      @unique
  color       String?     @default("#2563EB")
  displayOrder Int        @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  quickReplies QuickReply[]

  @@map("quick_reply_categories")
}

model QuickReplyUsage {
  id            String   @id @default(uuid())
  quickReplyId  String
  ticketId      String
  userId        String?
  queueId       String?
  createdAt     DateTime @default(now())

  quickReply    QuickReply @relation(fields: [quickReplyId], references: [id], onDelete: Cascade)
  ticket        Ticket     @relation("TicketQuickReplyUsage", fields: [ticketId], references: [id], onDelete: Cascade)
  user          User?      @relation("UserQuickReplyUsage", fields: [userId], references: [id], onDelete: SetNull)
  queue         Queue?     @relation("QueueQuickReplyUsage", fields: [queueId], references: [id], onDelete: SetNull)

  @@index([quickReplyId])
  @@index([ticketId])
  @@index([userId])
  @@map("quick_reply_usage")
}

model Notification {
  id          String               @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  body        String
  data        Json?
  channels    NotificationChannel[] @default([IN_APP])
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  metadata    Json?

  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id                   String   @id @default(uuid())
  userId               String   @unique
  notifyNewTicket      Boolean  @default(true)
  notifyTicketMessage  Boolean  @default(true)
  notifyTransfer       Boolean  @default(true)
  pushEnabled          Boolean  @default(false)
  emailEnabled         Boolean  @default(false)
  soundEnabled         Boolean  @default(true)
  soundTheme           String   @default("classic")
  smtpHost             String? 
  smtpPort             Int? 
  smtpUser             String?
  smtpPassword         String?
  smtpFrom             String?
  smtpSecure           Boolean  @default(true)
  quietHoursStart      Int?
  quietHoursEnd        Int?
  muteUntil            DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model NotificationSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  auth      String
  p256dh    String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_subscriptions")
}

enum TagMatchType {
  CONTAINS
  EXACT
  STARTS_WITH
}

model TagKeyword {
  id        String       @id @default(uuid())
  tagId     String
  keyword   String
  matchType TagMatchType @default(CONTAINS)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  tag Tag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, keyword])
  @@map("tag_keywords")
}
